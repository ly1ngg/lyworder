<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <base href="/">
    <link rel="icon" type="image/png" sizes="16x16" href="/ticket.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运维工单系统</title>
    <link href="./vendor/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./vendor/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --light-blue: #e6f0ff;
            --dark-blue: #2a4bd7;
            --success-color: #38b000;
            --warning-color: #ff9f1c;
            --danger-color: #e63946;
            --neutral-color: #f8f9fa;
            --border-radius: 0.75rem;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(67, 97, 238, 0.1);
            padding: 6px 12px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 100;
        }

        .login-prompt {
            text-align: center;
            margin-top: 50px;
        }

        /* 重新设计的工单表单 */
        .ticket-form-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .ticket-form-container:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .form-header {
            background: var(--primary-color);
            color: white;
            padding: 20px 25px;
            position: relative;
        }

        .form-header h2 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .form-header h2 i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .form-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .form-control {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 12px 15px;
            font-size: 16px;
            transition: all 0.2s ease;
            background-color: white;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .btn-submit {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-submit:hover {
            background-color: var(--dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .btn-submit:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(67, 97, 238, 0.3);
        }

        .btn-submit i {
            margin-right: 8px;
        }

        .form-footer {
            padding: 20px 30px;
            background-color: var(--neutral-color);
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
        }

        .message {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .message.success {
            background-color: rgba(56, 176, 0, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .message.error {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .ticket-form-container {
                width: 95%;
                margin: 20px auto;
                padding: 15px;
            }

            .form-header {
                padding: 8px 0;
                margin-bottom: 12px;
            }

            .form-body {
                padding: 8px 0;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .form-control {
                padding: 10px;
                font-size: 14px;
            }

            .btn-submit {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
                background-color: #f5f7fa;
            }

            .ticket-form-container {
                width: 98%;
                margin: 8px auto;
                padding: 15px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .user-info {
                top: 8px;
                right: 8px;
                padding: 5px 12px;
                font-size: 0.8rem;
                border-radius: 20px;
                background-color: rgba(67, 97, 238, 0.15);
            }

            h1 {
                font-size: 1.5rem;
                margin-top: 30px;
                margin-bottom: 18px;
                color: #2d3748;
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            }

            .form-header {
                padding: 12px 15px;
                border-radius: 8px 8px 0 0;
                background: linear-gradient(135deg, var(--primary-color), #5a73e8);
            }

            .form-header h2 {
                font-size: 1.1rem;
            }

            .preview-item {
                width: 100%;
                margin-bottom: 15px;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                transition: transform 0.2s ease;
            }

            .preview-item:hover {
                transform: translateY(-2px);
            }

            .preview-item img {
                width: 100%;
                height: auto;
                border-radius: 0;
                padding: 10px;
                background-color: #f9f9f9;
            }

            .btn-submit {
                width: 100%;
                padding: 15px;
                font-size: 15px;
                border-radius: 10px;
                box-shadow: 0 3px 6px rgba(67, 97, 238, 0.2);
            }

            .form-footer {
                padding: 15px;
                background-color: transparent;
                border-top: none;
            }

            .form-group {
                margin-bottom: 18px;
            }

            .form-group label {
                font-size: 0.95rem;
                margin-bottom: 8px;
                color: #4a5568;
                font-weight: 500;
            }

            .form-control {
                padding: 12px 14px;
                font-size: 14px;
                border-radius: 8px;
                border: 1px solid #e2e8f0;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
            }

            .message {
                padding: 12px 15px;
                font-size: 0.9rem;
                border-radius: 8px;
                margin-bottom: 15px;
            }

            .login-prompt {
                margin-top: 40px;
                padding: 20px;
                background-color: white;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .login-prompt button {
                padding: 12px 24px;
                background-color: var(--primary-color);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1rem;
                box-shadow: 0 3px 6px rgba(67, 97, 238, 0.2);
                transition: all 0.2s ease;
            }

            .login-prompt button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(67, 97, 238, 0.25);
            }
        }
    </style>
</head>

<body>
    <div class="user-info" id="user-info"></div>

    <h1 style="text-align: center; margin-top: 50px;">运维工单系统</h1>

    <div id="content-area">
        <!-- 重新设计的工单表单 -->
        <div class="ticket-form-container" id="ticket-form" style="display:none;">
            <div class="form-header">
                <h2><i class="fa fa-ticket"></i>提交新工单</h2>
            </div>
            <div class="form-body">
                <div class="message" id="message"></div>

                <div class="form-group">
                    <label for="title">标题 <span class="text-danger">*</span></label>
                    <input type="text" id="title" class="form-control" placeholder="请输入工单标题" required>
                </div>

                <div class="form-group">
                    <label for="content">问题描述 <span class="text-danger">*</span></label>
                    <textarea id="content" class="form-control" placeholder="请详细描述您遇到的问题或需要的帮助，支持粘贴图片"
                        required></textarea>
                </div>
                <div class="form-group">
                    <label>上传图片</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn btn-outline-primary"
                            onclick="document.getElementById('screenshots').click()">
                            <i class="fas fa-upload"></i> 选择图片
                        </button>
                        <span style="font-size: 0.9em; color: #6c757d;">或直接粘贴图片</span>
                    </div>
                    <input type="file" class="form-control" id="screenshots" accept="image/*" multiple
                        style="padding: 3px; display: none;">
                    <small class="form-text text-muted">支持JPG、PNG、WebP和GIF格式，最大5MB</small>
                    <div id="preview-container" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                        <!-- 动态生成的预览项将添加到这里 -->
                    </div>
                </div>
            </div>
            <div class="form-footer">
                <button class="btn-submit" onclick="createTicket()">
                    <i class="fa fa-paper-plane"></i>提交工单
                </button>
            </div>
        </div>

    </div>

    <script src="./vendor/js/jquery.min.js"></script>
    <script>
        const API_URL = '/api/v1/tickets';
        let pastedImages = [];
        let selectedFiles = [];

        // 初始化图片上传功能
        function initImageUpload() {
            // 监听粘贴事件
            const contentArea = document.getElementById('content');
            contentArea.addEventListener('paste', handlePaste);
            // 确保文本框可粘贴内容
            contentArea.setAttribute('contenteditable', 'true');
            // 监听文件选择事件
            document.getElementById('screenshots').addEventListener('change', handleFileSelect);
            // 页面加载时初始化
            handlePaste.bind(contentArea);
        }

        // 页面加载后立即初始化
        document.addEventListener('DOMContentLoaded', initImageUpload);

        // 处理粘贴事件
        function handlePaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let foundImage = false;

            // 处理文件类型的图片
            for (let item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        addImage(file, 'paste');
                        e.preventDefault();
                        foundImage = true;
                    }
                    break;
                }
            }

            if (foundImage) return;

            // 处理DataURL格式的图片（如从网页复制的图片）
            for (let item of items) {
                if (item.kind === 'string' && item.type === 'text/html') {
                    item.getAsString(function (html) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const img = doc.querySelector('img');
                        if (img && img.src.startsWith('data:image/')) {
                            // 将data URL转换为Blob
                            fetch(img.src)
                                .then(res => res.blob())
                                .then(blob => {
                                    const fileName = 'pasted-image-' + Date.now() + '.' + blob.type.split('/')[1];
                                    const file = new File([blob], fileName, { type: blob.type });
                                    addImage(file, 'paste');
                                    e.preventDefault();
                                });
                        }
                    });
                    break;
                }
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                addImage(files[i], 'select');
            }
        }

        function addImage(file, source) {
            // 验证文件类型
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('只支持JPG、PNG、WebP和GIF格式的图片', 'error');
                return;
            }

            // 验证文件大小
            if (file.size > 5 * 1024 * 1024) {
                showMessage('图片大小不能超过5MB', 'error');
                return;
            }

            // 根据来源添加到相应数组
            if (source === 'paste') {
                pastedImages.push(file);
                // 清除文件选择器的值
                document.getElementById('screenshots').value = '';
            } else if (source === 'select') {
                selectedFiles.push(file);
                // 清除粘贴的图片
                pastedImages = [];
            }

            // 创建预览项
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.style.position = 'relative';

            const img = document.createElement('img');
            img.style.width = '200px';
            img.style.height = '150px';
            img.style.objectFit = 'contain';
            img.style.backgroundColor = '#f8f9fa';
            img.style.borderRadius = '4px';
            img.style.border = '1px solid #ddd';
            img.style.padding = '5px';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-sm btn-danger';
            removeBtn.style.position = 'absolute';
            removeBtn.style.top = '-8px';
            removeBtn.style.right = '-8px';
            removeBtn.style.borderRadius = '50%';
            removeBtn.style.width = '24px';
            removeBtn.style.height = '24px';
            removeBtn.style.display = 'flex';
            removeBtn.style.alignItems = 'center';
            removeBtn.style.justifyContent = 'center';
            removeBtn.style.padding = '0';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = function () { removeImage(previewItem, file, source); };

            const reader = new FileReader();
            reader.onload = function (e) {
                img.src = e.target.result;
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                document.getElementById('preview-container').appendChild(previewItem);
                document.getElementById('preview-container').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        // 移除预览图片
        function removeImage(previewItem, file, source) {
            // 从DOM中移除预览项
            previewItem.remove();

            // 从数组中移除文件
            if (source === 'paste') {
                pastedImages = pastedImages.filter(img => img !== file);
            } else if (source === 'select') {
                selectedFiles = selectedFiles.filter(f => f !== file);
            }

            // 如果没有图片了，隐藏预览容器
            if (pastedImages.length === 0 && selectedFiles.length === 0) {
                document.getElementById('preview-container').style.display = 'none';
            }
        }

        async function createTicket() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;

            if (!title || !content) {
                showMessage('请填写标题和内容', 'error');
                return;
            }

            // 创建进度条容器
            const progressContainer = document.createElement('div');
            progressContainer.style.height = '5px';
            progressContainer.style.backgroundColor = '#eee';
            progressContainer.style.borderRadius = '3px';
            progressContainer.style.marginTop = '10px';
            progressContainer.style.overflow = 'hidden';

            const progressBar = document.createElement('div');
            progressBar.style.height = '100%';
            progressBar.style.backgroundColor = '#4CAF50';
            progressBar.style.width = '0%';
            progressBar.style.transition = 'width 0.3s ease';
            progressContainer.appendChild(progressBar);

            const messageElement = document.getElementById('message');
            messageElement.parentNode.insertBefore(progressContainer, messageElement.nextSibling);

            try {
                // 检查是否有图片（粘贴或选择）
                const allImages = [...pastedImages, ...selectedFiles];
                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);

                if (allImages.length > 0) {
                    allImages.forEach((img, index) => {
                        formData.append('screenshots', img);
                    });
                }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', API_URL, true);

                // 上传进度处理
                xhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressBar.style.width = percent + '%';
                    }
                });

                xhr.onload = function () {
                    progressContainer.style.display = 'none';

                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status >= 200 && xhr.status < 300) {
                            document.getElementById('title').value = '';
                            document.getElementById('content').value = '';
                            pastedImages = [];
                            selectedFiles = [];
                            document.getElementById('screenshots').value = '';
                            document.getElementById('preview-container').innerHTML = '';
                            document.getElementById('preview-container').style.display = 'none';

                            showMessage(`工单提交成功！ID: ${response.data.id}`, 'success');
                        } else {
                            showMessage(`提交失败: ${response.error || '未知错误'}`, 'error');
                        }
                    } catch (error) {
                        showMessage('解析响应失败，请检查控制台', 'error');
                        console.error('Error parsing response:', error);
                    }
                };

                xhr.onerror = function () {
                    progressContainer.style.display = 'none';
                    showMessage('网络错误，无法连接到服务器', 'error');
                };

                xhr.send(formData);
            } catch (error) {
                progressContainer.style.display = 'none';
                showMessage('提交失败，请重试', 'error');
                console.error('Error creating ticket:', error);
            }
        }

        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;

            // 移除所有类型类
            messageElement.classList.remove('success', 'error');

            // 添加对应类型类
            messageElement.classList.add(type);

            // 显示消息
            messageElement.style.display = 'block';

            // 3秒后隐藏消息
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        // 检查登录状态
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/v1/users', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const user = await response.json();
                    let adminLink = '';
                    if (user.data.role === 'admin') {
                        adminLink = ' | <a href="/operator">我的运维</a> | <a href="/admin">管理后台</a> ';
                    } else if (user.data.role === 'operator') {
                        adminLink = ' | <a href="/operator">我的运维</a>';
                    }
                    document.getElementById('user-info').innerHTML =
                        `<span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">欢迎，${user.data.user_name} | <a href="/tickets">我的工单</a>${adminLink} | <a href="/logout">退出</a></span>`;
                    document.getElementById('ticket-form').style.display = 'block';
                    document.getElementById('login-prompt').style.display = 'none';
                } else {
                    document.getElementById('ticket-form').style.display = 'none';
                    document.getElementById('login-prompt').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking login status:', error);
            }
        }

        // 页面加载时检查登录状态
        window.onload = checkLoginStatus;
    </script>
</body>

</html>