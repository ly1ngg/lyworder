<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <base href="/">
    <link rel="icon" type="image/png" sizes="16x16" href="/ticket.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工单详情 - 运维工单系统</title>
    <link href="./vendor/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./vendor/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --light-blue: #e6f0ff;
            --dark-blue: #2a4bd7;
            --success-color: #38b000;
            --warning-color: #ff9f1c;
            --danger-color: #e63946;
            --neutral-color: #f8f9fa;
            --border-radius: 0.75rem;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* 移动优先设计 - 基础样式 */
        @media (max-width: 992px) {
            body {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
                background-color: #f5f7fa;
                max-width: none;
            }
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(67, 97, 238, 0.1);
            padding: 6px 12px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 100;
        }

        @media (max-width: 480px) {
            .user-info {
                top: 10px;
                right: 10px;
                padding: 5px 12px;
                font-size: 0.8rem;
                border-radius: 20px;
                background-color: rgba(67, 97, 238, 0.15);
            }
        }

        .ticket-detail-container {
            margin: 50px auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ticket-detail-container:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        @media (max-width: 768px) {
            .ticket-detail-container {
                width: 100%;
                margin: 30px auto;
            }
        }

        @media (max-width: 480px) {
            .ticket-detail-container {
                width: 100%;
                margin: 30px auto 15px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
        }

        .detail-header {
            background: var(--primary-color);
            color: white;
            padding: 25px 30px;
            position: relative;
        }

        .detail-header h2 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .detail-header h2 i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .detail-header {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .detail-header {
                padding: 18px 15px;
            }

            .detail-header h2 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
        }

        .status-badge {
            position: absolute;
            top: 25px;
            right: 30px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .status-badge {
                position: static;
                display: inline-block;
                margin-top: 15px;
            }
        }

        @media (max-width: 480px) {
            .status-badge {
                position: static;
                display: inline-block;
                margin-top: 10px;
                padding: 4px 10px;
                font-size: 0.85rem;
            }
        }

        .status-open {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .status-closed {
            background-color: rgba(0, 0, 0, 0.2);
            color: #e0e0e0;
        }

        .detail-body {
            padding: 30px;
        }

        @media (max-width: 768px) {
            .detail-body {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .detail-body {
                padding: 15px;
            }
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        @media (max-width: 480px) {
            .detail-section {
                margin-bottom: 20px;
            }

            .detail-section h3 {
                font-size: 1.1rem;
                margin-bottom: 12px;
                color: #2d3748;
            }
        }

        .detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px 20px;
            margin-bottom: 20px;
        }

        .meta-item {
            flex: 1;
            min-width: 150px;
        }

        @media (max-width: 480px) {
            .detail-meta {
                gap: 12px;
            }

            .meta-item {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
                background-color: #f5f7fa;
                max-width: none;
            }

            .user-info {
                top: 10px;
                right: 10px;
                padding: 5px 12px;
                font-size: 0.8rem;
                border-radius: 20px;
                background-color: rgba(67, 97, 238, 0.15);
            }

            .ticket-detail-container {
                width: 100%;
                margin: 30px auto 15px;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .detail-header {
                padding: 18px 15px;
            }

            .detail-header h2 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .status-badge {
                position: static;
                display: inline-block;
                margin-top: 10px;
                padding: 4px 10px;
                font-size: 0.85rem;
            }

            .detail-body {
                padding: 15px;
            }

            .detail-section {
                margin-bottom: 20px;
            }

            .detail-section h3 {
                font-size: 1.1rem;
                margin-bottom: 12px;
                color: #2d3748;
            }

            .detail-meta {
                gap: 12px;
            }

            .meta-item {
                min-width: 100%;
            }

            .meta-label {
                font-size: 0.85rem;
            }

            .meta-value {
                font-size: 0.95rem;
            }

            .content-box {
                padding: 12px;
                font-size: 0.95rem;
                border-radius: 8px;
            }

            .section-card {
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .screenshot-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .screenshot-item {
                max-width: 100%;
            }

            .action-buttons {
                gap: 8px;
            }

            .btn-action {
                padding: 8px 14px;
                font-size: 0.9rem;
                border-radius: 8px;
                width: 100%;
                justify-content: center;
            }

            .modal-content img {
                max-width: 95%;
                max-height: 80vh;
            }
        }

        .meta-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .meta-value {
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .meta-label {
                font-size: 0.85rem;
            }

            .meta-value {
                font-size: 0.95rem;
            }
        }

        .content-box {
            background-color: var(--neutral-color);
            border-radius: var(--border-radius);
            padding: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow: auto;
        }

        @media (max-width: 480px) {
            .content-box {
                padding: 12px;
                font-size: 0.95rem;
                border-radius: 8px;
            }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-action {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            border: none;
            min-height: 44px;
            /* 确保足够的触摸目标高度 */
        }

        @media (max-width: 480px) {
            .btn-action {
                padding: 10px 20px;
                width: 100%;
                justify-content: center;
                min-height: 48px;
                /* 移动设备上更大的触摸目标 */
            }

            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .btn-action {
                padding: 10px 20px;
                width: 100%;
                justify-content: center;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--dark-blue);
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background-color: #5a6268;
        }

        .btn-action i {
            margin-right: 8px;
        }

        .section-card {
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .section-card {
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
        }

        .section-card h4 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: var(--border-radius);
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .loading-state {
            text-align: center;
            padding: 50px;
        }

        .loading-state i {
            font-size: 2em;
            margin-bottom: 15px;
            color: var(--primary-color);
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .screenshot-gallery img {
            cursor: pointer;
            transition: transform 0.3s;
            border: 1px solid #eee;
        }

        .screenshot-gallery img:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .screenshot-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 10px 0;
        }

        @media (max-width: 768px) {
            .screenshot-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .screenshot-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .screenshot-item {
            width: 100%;
            max-width: 200px;
            margin: 0 auto;
        }

        @media (max-width: 480px) {
            .screenshot-item {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .screenshot-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .screenshot-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .ticket-detail-container {
                width: 100%;
                margin: 30px auto;
            }

            .detail-header,
            .detail-body {
                padding: 20px;
            }

            .status-badge {
                position: static;
                display: inline-block;
                margin-top: 15px;
            }

        }
    </style>
</head>

<body>
    <div class="user-info" id="user-info"></div>

    <div class="ticket-detail-container">
        <div class="detail-header">
            <h2><i class="fa fa-ticket-alt"></i>工单详情</h2>
            <span class="status-badge" id="status-badge"></span>
        </div>
        <div class="detail-body">
            <div id="loading-state" class="loading-state">
                <i class="fas fa-spinner"></i>
                <p>加载中...</p>
            </div>

            <div id="ticket-content" style="display: none;">
                <div class="detail-section">
                    <h3 id="ticket-title"></h3>
                    <div class="detail-meta">
                        <div class="meta-item">
                            <div class="meta-label">工单ID</div>
                            <div class="meta-value" id="ticket-id"></div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">创建人</div>
                            <div class="meta-value" id="ticket-creator"></div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">处理人</div>
                            <div class="meta-value" id="ticket-operator"></div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">工单类型</div>
                            <div class="meta-value" id="ticket-type"></div>
                        </div>
                    </div>
                    <div class="detail-meta">
                        <div class="meta-item">
                            <div class="meta-label">创建时间</div>
                            <div class="meta-value" id="created-at"></div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">更新时间</div>
                            <div class="meta-value" id="updated-at"></div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>问题描述</h3>
                    <div class="content-box" id="ticket-description"></div>
                </div>

                <div class="detail-section">
                    <h3>备注信息</h3>
                    <div id="remark-section" class="section-card">
                        <div id="remark-content" class="content-box"></div>

                    </div>
                </div>

                <div class="detail-section">
                    <h3>解决方案</h3>
                    <div id="solution-section" class="section-card">
                        <div id="solution-content" class="content-box"></div>

                    </div>
                </div>

                <div class="detail-section">
                    <h3>问题截图</h3>
                    <div id="screenshot-section" class="section-card">
                        <div id="screenshot-content" class="screenshot-gallery"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-action btn-back" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="./vendor/jq/jquery-3.6.0.min.js"></script>
    <script src="./vendor/js/bootstrap.bundle.min.js"></script>
    <script>
        // 显示全屏图片
        function showFullImage(url, name) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '9999';
            modal.style.cursor = 'zoom-out';
            modal.onclick = function () { document.body.removeChild(modal); };

            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '30px';
            closeBtn.style.color = 'white';
            closeBtn.style.fontSize = '40px';
            closeBtn.style.fontWeight = 'bold';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.backgroundColor = 'transparent';
            closeBtn.style.border = 'none';
            closeBtn.onclick = function (e) {
                e.stopPropagation(); // 防止点击事件冒泡到模态框
                document.body.removeChild(modal);
                document.removeEventListener('keydown', closeModal);
            };
            modal.appendChild(closeBtn);

            // 添加ESC键关闭功能
            const closeModal = function (event) {
                if (event.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', closeModal);
                }
            };
            document.addEventListener('keydown', closeModal);

            const img = document.createElement('img');
            img.src = url;
            img.style.maxWidth = '90%';
            img.style.maxHeight = '90%';
            img.style.objectFit = 'contain';
            img.alt = name;

            modal.appendChild(img);
            document.body.appendChild(modal);
        }


        let ticketId = '';
        let currentUserRole = '';

        // 从URL获取工单ID
        function getTicketIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                throw new Error('missing_ticket_id');
            }

            const numericId = Number(id);
            if (isNaN(numericId)) {
                throw new Error('invalid_ticket_id');
            }

            return numericId;
        }

        // 获取工单详情
        async function getTicketDetail() {
            try {
                ticketId = getTicketIdFromUrl();
            } catch (error) {
                if (error.message === 'missing_ticket_id') {
                    showError('未找到工单ID参数');
                } else if (error.message === 'invalid_ticket_id') {
                    showError('无效的工单ID格式，请提供数字类型ID');
                } else {
                    showError('获取工单ID失败');
                }
                return;
            }

            try {
                const response = await fetch(`/api/v1/tickets/${ticketId}/detail`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('获取工单详情失败');
                }

                const data = await response.json();
                renderTicketDetail(data);
            } catch (error) {
                console.error('Error getting ticket detail:', error);
                showError('加载工单详情失败，请重试');
            }
        }

        // 渲染工单详情
        function renderTicketDetail(ticket) {
            document.getElementById('ticket-id').textContent = ticket.id || '未知';
            document.getElementById('ticket-title').textContent = ticket.title || '无标题';
            document.getElementById('ticket-creator').textContent = ticket.user_name || '未知';
            document.getElementById('ticket-operator').textContent = ticket.operator_name || '未分配';
            document.getElementById('ticket-type').textContent = ticket.ticket_type || '未分类';
            document.getElementById('created-at').textContent = ticket.created_at ? new Date(ticket.created_at).toLocaleString() : '未知';
            document.getElementById('updated-at').textContent = ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : '未更新';
            document.getElementById('ticket-description').textContent = ticket.content || '无描述';

            // 设置状态标签
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = ticket.status === 'open' ? '进行中' : '已关闭';
            statusBadge.className = `status-badge status-${ticket.status}`;

            // 渲染备注
            const remarkContent = document.getElementById('remark-content');
            if (ticket.remark) {
                remarkContent.innerHTML = ticket.remark.replace(/\n/g, '<br>');
            } else {
                remarkContent.innerHTML = '<div class="empty-state"><i class="fas fa-sticky-note"></i><p>暂无备注信息</p></div>';
            }

            // 渲染解决方案
            const solutionContent = document.getElementById('solution-content');
            if (ticket.solution) {
                solutionContent.innerHTML = ticket.solution.replace(/\n/g, '<br>');
            } else {
                solutionContent.innerHTML = '<div class="empty-state"><i class="fas fa-lightbulb"></i><p>暂无解决方案</p></div>';
            }

            // 渲染问题截图
            const screenshotContent = document.getElementById('screenshot-content');
            const renderScreenshots = (screenshots) => {
                if (!Array.isArray(screenshots) || screenshots.length === 0) {
                    return '<div class="empty-state"><i class="fas fa-camera"></i><p>暂无问题截图</p></div>';
                }

                return `
                    <div class="screenshot-container">
                        ${screenshots.map((screenshot, index) => {
                    const url = typeof screenshot === 'string' ? screenshot : screenshot.url;
                    return `
                                <div class="screenshot-item">
                                    <img src="${url}" class="img-fluid rounded" style="width: 200px; height: 150px; object-fit: contain; background-color: #f8f9fa; padding: 5px; cursor: pointer;" alt="问题截图" onclick="showFullImage('${url}', '${name}')"/>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            };

            screenshotContent.innerHTML = renderScreenshots(ticket.screenshots);



            // 显示内容，隐藏加载状态
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('ticket-content').style.display = 'block';
        }

        // 显示错误信息
        function showError(message) {
            document.getElementById('loading-state').innerHTML = `
                <div style="color: var(--danger-color);">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        // 检查登录状态
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/v1/users', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const user = await response.json();
                    currentUserRole = user.data.role;
                    let userLinks = '';
                    if (user.data.role === 'admin') {
                        userLinks = ' | <a href="/operator">我的运维</a> | <a href="/admin">管理后台</a> ';
                    } else if (user.data.role === 'operator') {
                        userLinks = ' | <a href="/operator">我的运维</a>';
                    }
                    document.getElementById('user-info').innerHTML =
                        `<span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">欢迎，${user.data.user_name} | <a href="/tickets">我的工单</a>${userLinks} | <a href="/logout">退出</a></span>`;
                    getTicketDetail();
                } else {
                    window.location.href = '/login?redirect=ticket_detail.html';
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                showError('登录状态验证失败，请刷新页面重试');
            }
        }

        // 页面加载时检查登录状态并获取工单详情
        window.onload = checkLoginStatus;
    </script>


</body>

</html>